{{define "content"}}

<div class="row mb-3 align-items-center">
    <div class="col-md-8">
        <h2>
            {{.Sensor.Name}} 
            <span class="text-muted fs-5">Historie</span>
        </h2>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group">
            <a href="?range=1h" class="btn btn-outline-secondary {{if eq .Range "1h"}}active{{end}}">1h</a>
            <a href="?range=24h" class="btn btn-outline-secondary {{if eq .Range "24h"}}active{{end}}">24h</a>
            <a href="?range=168h" class="btn btn-outline-secondary {{if eq .Range "168h"}}active{{end}}">7d</a>
        </div>
        <a href="/" class="btn btn-secondary ms-2">Zpět</a>
    </div>
</div>

<div class="card shadow-sm p-3">
    <canvas id="historyChart" style="max-height: 400px;"></canvas>
</div>

<script>
    /* * PŘEDÁNÍ DAT Z GO (SERVER) DO JS (KLIENT)
     * ========================================
     * Toto je kritické místo. Go šablona se vykoná na serveru a "vytiskne"
     * výsledek přímo do zdrojového kódu stránky, která letí do prohlížeče.
     * * .Points je Go struktura ([]HistoryPoint).
     * Pipe operator "|" předá tato data funkci "to_json", kterou jsme definovali v handleru.
     * Ta zajistí, že výsledek bude validní JSON string (např. [{"t":"...","v":10}]).
     * * Pokud bychom nepoužili to_json, Go by vypsalo svou string reprezentaci [{...}],
     * což je pro JavaScript syntaktická chyba.
     */
    const rawData = {{ .Points | to_json }};
    
    // Debugging: Podívej se do konzole prohlížeče (F12), co přesně přišlo.
    console.log("Data přijatá z backendu:", rawData);

    if (!rawData || rawData.length === 0) {
        console.warn("Graf nemá žádná data k zobrazení.");
        // Zde by se hodilo zobrazit uživateli hlášku "Žádná data".
    } else {
        
        // TRANSFORMACE DAT
        // Chart.js potřebuje dvě oddělená pole: Labels (X) a Data (Y).
        
        // 1. Osa X (Labels): Formátování času
        const labels = rawData.map(p => {
            // Datum z JSONu je string (ISO 8601), musíme ho převést na JS Date objekt.
            const d = new Date(p.t);
            // Formátujeme na lokální čas (např. "14:30")
            return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        });

        // 2. Osa Y (Data): Hodnoty
        const dataValues = rawData.map(p => p.v);

        // VYKRESLENÍ GRAFU
        const ctx = document.getElementById('historyChart');
        new Chart(ctx, {
            type: 'line', // Typ grafu
            data: {
                labels: labels,
                datasets: [{
                    label: 'Hodnota ({{.Sensor.Unit}})', // Go doplní jednotku
                    data: dataValues,
                    borderColor: 'rgb(75, 192, 192)', // Tyrkysová barva
                    backgroundColor: 'rgba(75, 192, 192, 0.1)', // Průhledná výplň
                    borderWidth: 2,
                    tension: 0.3, // "Curve tension" - 0 = lomená čára, 1 = velmi kulaté
                    fill: true,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: true, title: { display: true, text: 'Čas' } },
                    y: { beginAtZero: false } // Graf se přizpůsobí rozsahu hodnot
                },
                plugins: {
                    legend: { position: 'top' }
                }
            }
        });
    }
</script>

{{end}}